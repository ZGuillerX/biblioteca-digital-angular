<div class="container mt-4">
  <button class="btn btn-outline-secondary mb-3" (click)="goBack()">
    Volver al Catálogo
  </button>

  <div *ngIf="loading" class="text-center mt-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Cargando libro...</p>
  </div>

  <div *ngIf="error && !book" class="mt-5">
    <div class="alert alert-danger">{{ error }}</div>
    <button class="btn btn-secondary" (click)="goBack()">
      Volver al Catálogo
    </button>
  </div>

  <ng-container *ngIf="!loading && book">
    <div class="alert alert-danger alert-dismissible" *ngIf="error">
      {{ error }}
      <button type="button" class="btn-close" (click)="clearError()"></button>
    </div>

    <div class="alert alert-success alert-dismissible" *ngIf="success">
      {{ success }}
      <button type="button" class="btn-close" (click)="clearSuccess()"></button>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <img
              [src]="book.cover_url || 'assets/default-cover.svg'"
              [alt]="book.title"
              style="
                width: 180px;
                height: 260px;
                object-fit: cover;
                border-radius: 6px;
              "
              loading="lazy"
            />
          </div>

          <div class="col-md-8">
            <h2>{{ book.title }}</h2>
            <h5 class="text-muted mb-3">{{ book.author }}</h5>

            <div class="mb-3">
              <span
                class="badge me-2"
                [class.bg-success]="isAvailable()"
                [class.bg-danger]="!isAvailable()"
              >
                {{
                  isAvailable()
                    ? book.available_copies + " disponibles"
                    : "No disponible"
                }}
              </span>
              <span class="badge bg-secondary"
                >Total: {{ book.total_copies }}</span
              >
            </div>

            <hr />

            <div class="row mb-3">
              <div class="col-sm-6"><strong>ISBN:</strong> {{ book.isbn }}</div>
              <div class="col-sm-6">
                <strong>Categoría:</strong>
                {{ book.category || "Sin categoría" }}
              </div>
              <div class="col-sm-6 mt-2">
                <strong>Año:</strong> {{ book.publication_year || "N/A" }}
              </div>
            </div>

            <div *ngIf="book.description">
              <h5>Descripción</h5>
              <p>{{ book.description }}</p>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card bg-light">
              <div class="card-body">
                <h5 class="mb-3">Acciones</h5>

                <ng-container *ngIf="isAuthenticated; else notAuthBlock">
                  <button
                    *ngIf="hasActiveLoan"
                    class="btn btn-success w-100 mb-2"
                    (click)="handleReadBook()"
                  >
                    Leer Libro Completo
                  </button>

                  <button
                    *ngIf="isAvailable() && !hasActiveLoan"
                    class="btn btn-primary w-100 mb-2"
                    (click)="handleLoanRequest()"
                  >
                    Solicitar Préstamo
                  </button>

                  <div
                    *ngIf="!isAvailable() && !hasActiveLoan"
                    class="alert alert-warning mb-2"
                  >
                    Este libro no está disponible actualmente
                  </div>

                  <div *ngIf="hasActiveLoan" class="alert alert-info mb-2">
                    <small>Tienes este libro en préstamo</small>
                  </div>
                </ng-container>

                <ng-template #notAuthBlock>
                  <div class="alert alert-info mb-2">
                    <small>Inicia sesión para solicitar préstamos</small>
                  </div>
                </ng-template>

                <button
                  class="btn btn-outline-info w-100"
                  (click)="handlePreviewBook()"
                >
                  Vista Previa
                </button>
          
                <app-book-reviews [book]="book" *ngIf="book" (reviewUpdated)="loadBook(book.id)"></app-book-reviews>
                
                <div *ngIf="book?.average_rating">
                  Calificación promedio:
                  {{ book.average_rating | number : "1.1-1" }} ({{
                    book.total_reviews
                  }}
                  reseñas)
                </div>

                
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sección del lector de libros -->
    <div class="mt-4" *ngIf="showReader">
      <app-book-reader
        [bookId]="book.id"
        [isPreview]="isPreviewMode"
      ></app-book-reader>
    </div>
  </ng-container>
</div>
